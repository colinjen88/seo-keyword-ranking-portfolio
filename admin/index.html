<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin - Sort Order</title>
    <link rel="stylesheet" href="style.css">
    <!-- Load initial data -->
    <script src="../data/items.js"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>

<body>

    <div class="container">
        <header>
            <div>
                <h1>üé¥ Portfolio Card Manager</h1>
                <p style="color: #94a3b8; margin: 0;">Drag and drop to reorder items.</p>
            </div>
            <div class="actions">
                <a href="/" target="_blank" class="btn btn-secondary"
                    style="text-decoration:none; display:inline-flex; align-items:center;">View Site ‚Üó</a>
                <button id="saveBtn" class="btn btn-primary">Save Changes</button>
            </div>
        </header>

        <div id="grid" class="grid">
            <!-- Items rendered here -->
        </div>
    </div>

    <div id="toast">Saved Successfully!</div>

    <script>
        // Use local copy of items
        let items = window.portfolioItems || [];
        const grid = document.getElementById('grid');
        const saveBtn = document.getElementById('saveBtn');
        const toast = document.getElementById('toast');

        // Render items
        function render() {
            grid.innerHTML = '';
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'card-item';
                el.setAttribute('data-id', item.id);

                // Determine active state classes
                const aiActiveClass = item.showAiSummary ? 'tag-active ai' : '';
                const featActiveClass = item.showFeaturedSummary ? 'tag-active feat' : '';

                el.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="../${item.image}" class="card-img" loading="lazy">
                        <div class="drag-handle">‚ò∞</div>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${item.title}</h3>
                        <div class="card-meta">
                            <span>Rank: #${item.rank}</span>
                            <span>${item.date}</span>
                        </div>
                        <div class="card-tags">
                            <button class="tag-btn ${aiActiveClass}" onclick="toggleTag('${item.id}', 'showAiSummary')">
                                #AIÊëòË¶Å
                            </button>
                            <button class="tag-btn ${featActiveClass}" onclick="toggleTag('${item.id}', 'showFeaturedSummary')">
                                #Á≤æÈÅ∏ÊëòË¶Å
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        // Toggle Tag Function
        window.toggleTag = function (id, property) {
            const item = items.find(i => i.id === id);
            if (item) {
                // Toggle boolean
                item[property] = !item[property];
                // Re-render to show update (or just update class for performance, but re-render is safer for sync)
                render();
            }
        };

        render();

        // Init Sortable
        new Sortable(grid, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function () {
                // Update local order based on DOM
                const newOrderIds = Array.from(grid.children).map(el => el.getAttribute('data-id'));

                // Reorder items array
                const newItems = newOrderIds.map(id => items.find(i => i.id === id));
                items = newItems;
            }
        });

        // Save Function
        saveBtn.addEventListener('click', async () => {
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            try {
                const response = await fetch('/api/save-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(items)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Saved Successfully!');
                } else {
                    showToast('Error: ' + data.error, true);
                }
            } catch (err) {
                console.error(err);
                if (window.location.protocol === 'file:') {
                    alert('You are running from file system. Cannot save automatically.\nCheck console for JSON data.');
                    console.log(JSON.stringify(items, null, 4));
                } else {
                    showToast('Failed to connect to server.', true);
                }
            } finally {
                saveBtn.textContent = 'Save Changes';
                saveBtn.disabled = false;
            }
        });

        function showToast(msg, isError = false) {
            toast.textContent = msg;
            toast.className = isError ? 'error' : '';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

    </script>
</body>

</html>